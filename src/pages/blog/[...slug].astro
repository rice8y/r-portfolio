---
import { type CollectionEntry, getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import FormattedDate from "@components/FormattedDate.astro";
import { readingTime } from "@lib/utils";
import BackToPrev from "@components/BackToPrev.astro";

export async function getStaticPaths() {
  const posts = (await getCollection("blog"))
    .filter(post => !post.data.draft)
    .sort((a, b) => {
      const aDate = a.data.updatedDate ?? a.data.publishedDate;
      const bDate = b.data.updatedDate ?? b.data.publishedDate;
      return bDate.valueOf() - aDate.valueOf();
    });
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content } = await post.render();
---

<PageLayout title={post.data.title} description={post.data.description}>
  <Container>
    <div class="animate">
      <BackToPrev href="/blog">
        Back to blog
      </BackToPrev>
    </div>
    <div class="space-y-1 my-10">
      <div class="animate flex items-center gap-1.5">
        <div class="font-base text-sm">
          <FormattedDate date={post.data.publishedDate} />
        </div>
        &bull;
        <div class="font-base text-sm">
          {readingTime(post.body)}
        </div>
      </div>
      <div class="animate text-2xl font-semibold text-black dark:text-white">
        {post.data.title}
      </div>
    </div>
    <article class="animate">
      <Content />
    </article>

    <div class="animate mt-14">
      <script is:inline src="https://giscus.app/client.js"
        data-repo="rice8y/r-portfolio"
        data-repo-id="R_kgDOPmTTJw"
        data-category="Announcements"
        data-category-id="DIC_kwDOPmTTJ84C25yk"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="transparent_dark" 
        data-lang="ja"
        crossorigin="anonymous"
        async>
      </script>

      <script is:inline>
        function updateGiscusTheme() {
          const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
          const iframe = document.querySelector('iframe.giscus-frame');
          
          if (!iframe) return;
          
          iframe.contentWindow.postMessage(
            { giscus: { setConfig: { theme: theme } } },
            'https://giscus.app'
          );
        }

        const observer = new MutationObserver(updateGiscusTheme);
        observer.observe(document.documentElement, { 
          attributes: true, 
          attributeFilter: ['class'] 
        });

        window.addEventListener('message', (event) => {
          if (event.origin === 'https://giscus.app') {
            updateGiscusTheme();
          }
        });
      </script>
    </div>
  </Container>
</PageLayout>